name: Tailscale Live Node Notification

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 */6 * * *" # Every 6 hours

jobs:
  tailscale-node:
    runs-on: ubuntu-latest

    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Enable IP Forwarding
        run: |
          sudo sysctl -w net.ipv4.ip_forward=1
          sudo sysctl -w net.ipv6.conf.all.forwarding=1

      - name: Get Runner Hostname
        id: runner_info
        run: |
          RUNNER_NAME=$(hostname)
          echo "runner_name=$RUNNER_NAME" >> $GITHUB_OUTPUT
          echo "runner_name=$RUNNER_NAME" >> $GITHUB_ENV

      - name: Start Tailscale Exit Node
        run: |
          sudo tailscale up \
            --authkey ${{ secrets.TAILSCALE_PREAUTHKEY }} \
            --ssh \
            --advertise-exit-node \
            --hostname ${{ steps.runner_info.outputs.runner_name }} \
            --reset
        env:
          TS_SOCKET: /tmp/tailscaled.sock

      - name: Live Update Telegram Notification
        id: telegram_notification
        run: |
          START_TIME=$(date +%s)
          
          # Initial message setup
          TAILSCALE_IP=$(sudo tailscale ip -4)
          PUBLIC_IP=$(curl -s ifconfig.me)
          LOCATION=$(curl -s https://ipapi.co/$PUBLIC_IP/city/,%20$PUBLIC_IP/country_name/)
          COUNTRY_FLAG=$(curl -s https://ipapi.co/$PUBLIC_IP/country/)
          ISP=$(curl -s https://ipapi.co/$PUBLIC_IP/org/)

          CURRENT_HOUR_UTC=$(date -u +%H)
          NEXT_HOUR_UTC=$(( ( (CURRENT_HOUR_UTC / 6 + 1) * 6 ) % 24 ))
          NEXT_RUN_UTC=$(printf "%02d:00:00" "$NEXT_HOUR_UTC")
          
          INIT_MSG=$(cat <<EOF
ðŸš€ Tailscale Node Online
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ–¥ï¸  Runner         : ${{ steps.runner_info.outputs.runner_name }}
ðŸŒ  Tailscale IP   : $TAILSCALE_IP
ðŸŒ  Public IP      : $PUBLIC_IP
ðŸ“  Location       : $LOCATION $COUNTRY_FLAG
ðŸ¢  ISP            : $ISP
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â±ï¸  Running since  : 00:00:00
â°  Next workflow  : $NEXT_RUN_UTC UTC
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
EOF
)

          MSG_ID=$(curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TG_CHAT_ID }} \
            -d text="$INIT_MSG" \
            | jq -r '.result.message_id')
          
          echo "message_id=$MSG_ID" >> $GITHUB_OUTPUT

          END_TIME=$((START_TIME + 21600))
          while [ $(date +%s) -lt $END_TIME ]; do
            NOW=$(date +%s)
            ELAPSED=$((NOW - START_TIME))
            RUNNING=$(printf '%02d:%02d:%02d' $((ELAPSED/3600)) $(((ELAPSED/60)%60)) $((ELAPSED%60)))

            TAILSCALE_IP=$(sudo tailscale ip -4)
            PUBLIC_IP=$(curl -s ifconfig.me)
            LOCATION=$(curl -s https://ipapi.co/$PUBLIC_IP/city/,%20$PUBLIC_IP/country_name/)
            COUNTRY_FLAG=$(curl -s https://ipapi.co/$PUBLIC_IP/country/)
            ISP=$(curl -s https://ipapi.co/$PUBLIC_IP/org/)
            
            UPDATED_MSG=$(cat <<EOF
ðŸš€ Tailscale Node Online
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ–¥ï¸  Runner         : ${{ steps.runner_info.outputs.runner_name }}
ðŸŒ  Tailscale IP   : $TAILSCALE_IP
ðŸŒ  Public IP      : $PUBLIC_IP
ðŸ“  Location       : $LOCATION $COUNTRY_FLAG
ðŸ¢  ISP            : $ISP
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â±ï¸  Running since  : $RUNNING
â°  Next workflow  : $NEXT_RUN_UTC UTC
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
EOF
)

            curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/editMessageText \
              -d chat_id=${{ secrets.TG_CHAT_ID }} \
              -d message_id=$MSG_ID \
              -d text="$UPDATED_MSG"

            sleep 300
          done
        env:
          TS_SOCKET: /tmp/tailscaled.sock

      - name: Send Telegram Stop Notification
        if: always()
        run: |
          TAILSCALE_IP=$(sudo tailscale ip -4)
          PUBLIC_IP=$(curl -s ifconfig.me)
          LOCATION=$(curl -s https://ipapi.co/$PUBLIC_IP/city/,%20$PUBLIC_IP/country_name/)
          COUNTRY_FLAG=$(curl -s https://ipapi.co/$PUBLIC_IP/country/)
          ISP=$(curl -s https://ipapi.co/$PUBLIC_IP/org/)
          MSG=$(cat <<EOF
ðŸ›‘ Tailscale Node Stopped
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ–¥ï¸  Runner         : ${{ steps.runner_info.outputs.runner_name }}
ðŸŒ  Tailscale IP   : $TAILSCALE_IP
ðŸŒ  Public IP      : $PUBLIC_IP
ðŸ“  Location       : $LOCATION $COUNTRY_FLAG
ðŸ¢  ISP            : $ISP
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â±ï¸  Total running time: Workflow completed.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
EOF
)

          curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TG_CHAT_ID }} \
            -d text="$MSG"
        env:
          TS_SOCKET: /tmp/tailscaled.sock
          
<br>

***

<br>

## Bot Outputs and Explanation ðŸ¤–

When this workflow runs successfully, you'll see a series of bot messages in your specified Telegram chat.

### Initial Message
A message will appear in your Telegram chat soon after the workflow starts, confirming the new Tailscale node is online. This is the output from the `Live Update Telegram Notification` step's initial `curl` command.

<br>

### Live Updates
Every 5 minutes (`sleep 300`), the `while` loop will execute. The script will fetch the latest network information (which should remain constant unless the runner is moved) and update the `Running since` timer. The `editMessageText` API call ensures the original message is edited in place, creating a "live update" effect.

<br>

### Final Notification
When the workflow completes (after 6 hours or if it is manually canceled), the `Send Telegram Stop Notification` step will run due to the `if: always()` condition. A final message will be sent to the chat, notifying you that the node is no longer active.

This video demonstrates a different, simpler GitHub Actions workflow that automatically deploys a static website, which is another common use case for these kinds of scripts.

[Static site deployments made easy with Github Actions and Tailscale](https://www.youtube.com/watch?v=OQJAX-Ce1YY)
http://googleusercontent.com/youtube_content/3
